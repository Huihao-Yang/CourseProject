pipline_calculate.py模拟精馏塔逐板计算的可视化

rectification_calculate.py模拟化工原理管路计算的可视化

# 思路分析

## 精馏塔逐板计算

### 逐板法计算求解理论板数和最小回流比

所需要用到的公式
$$
气液相平衡方程:y=\frac{\alpha x}{1+(\alpha x-1)},其中\alpha 为平均挥发度,y,x分别表示苯的气相和液相摩尔分率\\
精馏段操作线方程:y_{n+1}=\frac{R}{R+1}x_n+\frac{x_D}{R+1}\\其中y_{n+1},x+n分别表示轻组分在第n+1块和第n块塔板
的汽相和液相摩尔分率，\\x_D为馏出液摩尔分率，R表示回流比\\
q线方程:y=\frac{q}{q-1}x-\frac{x_F}{q-1},其中q为进料热状况，x_F表示进料组成\\
提馏段操作线方程:y=\frac{x_W-y_{Dq}}{x_W-x_{Dq}}x+\frac{y_{Dq}-x_{Dq}}{x_W-x_{Dq}}x_w\\
其中,x_W表示釜液摩尔分率,(x_{Dq},y_{Dq})为q线方程与精馏段操作线方程的交点\\
最小回流比:Rmin=\frac{x_D-y_d}{y_d-x_d},其中(x_d,y_d)为q线方程与气液相平衡线的交点
$$

1. 先计算q线方程与精馏段操作方程、气液相平衡方程的交点，记为(x1,y1)、(x2,y2)
2. 将(x1,y1)带入提馏段操作线方程，根据xD、(x2,y2)计算最小回流比
3. 绘制气液相平衡方程、精馏段操作线方程、q线方程、提馏段操作线方程的图像

**计算理论塔板数**

![](iteration.png)

$$
相平衡方程:y=\frac{\alpha x}{1+(\alpha-1)x}->x=\frac{y}{\alpha-(\alpha-1)y}\\
对给定的组成y_n可以方便地通过平衡线方程解出x_n。\\
对于非理想物系或者只有汽液相平衡数据的二元物系，这一方法并不适用。\\
为了使我们的代码具有普适性\\
我们选择通过二元物系的汽液相平衡实验数据获得任意塔板上的汽液相组成
$$

1. 从数据文件中读入相平衡条件下的温度与汽液相组成关系(t-x-y)
2. 利用scipy模块库中的样条插值程序splrep将离散的x-y数值转换成为插值系数
3. 对于任何的y~n~均代入样条插值的求值函数splev中求取对应的

```python
def get_x(y):
    # 利用苯-甲苯.xlsx进行插值计算yn对应的xn
    Y = [0, 0.025, 0.0711, 0.112, 0.208, 0.294, 0.372, 0.442, 0.507, 0.566, 0.619, 0.667, 0.713, 0.755, 0.791, 0.825,
         0.857, 0.885, 0.912, 0.936, 0.959, 0.98, 0.988, 0.9961, 1]  # yn
    X = [0, 0.01, 0.03, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85,
         0.9, 0.95, 0.97, 0.99, 1]  # xn
    spl = splrep(Y, X)  # 获取插值系数
    return splev(y, spl)  # 进行插值
```

### 精馏塔的气液相组成及温度分布曲线

需要用到的公式
$$
A:苯,B:甲苯\\
苯的安托因方程:log(p^0_A)=6.031-\frac{1211}{t+220.8}->p^0_A=10^{6.031-\frac{1211}{t+220.8}}\\
甲苯的安托因方程:log(p^0_B)=6.080-\frac{1345}{t+219.5}->p^0_B=10^{6.080-\frac{1345}{t+219.5}}\\
其中,p^0_A,p^0_B的单位为kPa,温度t的单位为℃\\
露点方程y_A=\frac{p^0_A}{P}\frac{P-p^0_B}{p^0_A-p^0_B}\\
其中y_A为苯在气相中摩尔分率,P为标准大气压
$$

1. 计算理论板数时得到每一块塔板平衡时苯的气相摩尔分率
2. 对于每一个确定的y~A~，将苯的安托因方程、甲苯的安托因方程与露点方程联立即可解出对应的温度t

## 化工原理管路计算

管路计算时需要用到的计算公式
$$
层流时,λ=\frac{64}{Re}\\
湍流时,\frac{1}{\sqrt{λ}}=2lg\frac{d}{\epsilon}+1.14-2lg(1+9.35\frac{d/\epsilon}{Re\sqrt{λ}})\\
Re=\frac{du\rho}{\mu}\\
伯努利方程:g{\Delta}Z+\frac{{\Delta}p}{\rho}=(λ\frac{l+\sum l_e}{d}+1.0+\zeta _c)\frac{u^2}{2}\\
变形可得u=\sqrt{\frac{2(g{\Delta}Z+\frac{{\Delta}p}{\rho})}{λ\frac{l+\sum l_e}{d}+1.0+\zeta _c}}\\
\rho 为流体的密度,u为流体的流速,\Delta z和\Delta p分别表示截面间的高度差和压强差,\\
Re为雷诺数,λ为摩擦系数,l为管长,l_e为管件与阀门的当量长度,\\ 
\mu 为粘度,\zeta _c为管路进口摩擦系数，取为0.5
$$
因为，绘图时是针对λ-Re的变化趋势进行绘制，因此**迭代计算时,我们选取的二元变量为λ(摩擦系数)和Re(雷诺系数)**

**迭代终止条件为**
$$
|\lambda _{k+1}-\lambda _k|<\varepsilon并且|Re_{k+1}-Re_k|<\varepsilon\\
其中\varepsilon 为迭代精度,即允许误差,计算时取0.001
\\(\lambda _k,Re_k)为第k次迭代的值,(\lambda _{k+1},Re_{k+1})为第k+1次迭代的值
$$

### 试差法

理论公式
$$
已知x_1=f(x_1,x_2),x_2=g(x_1,x_2)\\
迭代公式为:\\
x_1(k+1)=f(x_1(k),x_2(k))\\
x_2(k+1)=g(x_1(k),x_2(k))
$$

对公式进行变形
$$
湍流假定(Colebrook公式):\lambda=(\frac{1}{2lg\frac{d}{\epsilon}+1.14-2lg(1+9.35\frac{d/\epsilon}{Re\sqrt{λ}})})^2=g_1(\lambda,Re)\\
层流假定:λ=\frac{64}{Re}=g_2(λ,Re)\\
伯努利方程:Re=\frac{du\rho}{\mu}=\frac{d\rho}{\mu}\sqrt{\frac{2(g{\Delta}Z+\frac{{\Delta}p}{\rho})}{λ\frac{l+\sum l_e}{d}+1.0+\zeta _c}}=f(λ,Re)\\
迭代公式为:\\
\lambda(k+1)=f(\lambda(k),Re(k))\\
Re(k+1)=g(\lambda(k),Re(k))
$$

1. 对层流时Re-λ关系式、湍流时Re-λ关系式、伯努利方程进行变形，得到迭代需要的方程形式
2. 将变形后的层流时Re-λ关系式、湍流时Re-λ关系式分别与伯努利方程联立
3. 对联立的二元非线性方程组应用上面的公式进行迭代求解

### 松弛迭代法

理论公式
$$
已知x_1=f(x_1,x_2),x_2=g(x_1,x_2)\\
迭代公式为:\\
x_1(k+1)=x_1(k)+w*(f(x_1(k),x_2(k))-x_1(k))\\
x_2(k+1)=x_2(k)+w*(g(x_1(k),x_2(k))-x_2(k))\\
其中w为松弛因子
$$

对公式进行变形
$$
松弛因子w取为0.5\\
湍流假定(Colebrook公式):\lambda=(\frac{1}{2lg\frac{d}{\epsilon}+1.14-2lg(1+9.35\frac{d/\epsilon}{Re\sqrt{λ}})})^2=g_1(\lambda,Re)\\
层流假定:λ=\frac{64}{Re}=g_2(λ,Re)\\
伯努利方程:Re=\frac{du\rho}{\mu}=\frac{d\rho}{\mu}\sqrt{\frac{2(g{\Delta}Z+\frac{{\Delta}p}{\rho})}{λ\frac{l+\sum l_e}{d}+1.0+\zeta _c}}=f(λ,Re)\\
迭代公式为:\\
\lambda(k+1)=\lambda(k)+0.5*(f(\lambda(k),Re(k))-\lambda(k))\\
Re(k+1)=Re(k)+0.5*(g(\lambda(k),Re(k))-Re(k))
$$

1. 对层流时Re-λ关系式、湍流时Re-λ关系式、伯努利方程进行变形，得到迭代需要的方程形式
2. 将变形后的层流时Re-λ关系式、湍流时Re-λ关系式分别与伯努利方程联立
3. 对联立的二元非线性方程组应用上面的公式进行迭代求解

### 牛顿迭代法

理论公式
$$
对n元非线性方程组,X=(x_1,x_2,……,x_n)^T,F=(f_1,f_2,……,f_n)^T,其求根公式为\\X^{(k+1)}=X^{(k)}-F'(X^{(k)})^{-1}F(X^{(k)})\\
特别地对于二元非线性方程组f(x,y)=0和g(x,y)=0,迭代公式如下\\
x_{k+1}=x_{k}+\frac{fg_y-gf_y|_{(x_k,y_k)}}{g_xf_y-f_xg_y|_{(x_k,y_k)}}\\
y_{k+1}=y_k+\frac{gf_x-fg_x|_{(x_k,y_k)}}{g_xf_y-f_xg_y|_{(x_k,y_k)}}\\
其中,f_x表示f(x,y)对x的偏导数,f_y表示f(x,y)对y的偏导数,其余符号同理
$$

对公式进行变形
$$
湍流假定(Colebrook公式):g_1(λ,Re)=-\frac{1}{\sqrt{λ}}+2lg\frac{d}{\epsilon}+1.14-2lg(1+9.35\frac{d/\epsilon}{Re\sqrt{λ}})=0\\
层流假定:g_2(λ,Re)=λ-\frac{64}{Re}=0\\
伯努利方程:f(λ,Re)=u-\sqrt{\frac{2(g{\Delta}Z+\frac{{\Delta}p}{\rho})}{λ\frac{l+\sum l_e}{d}+1.0+\zeta _c}}=\frac{Re\mu}{d\rho}-\sqrt{\frac{2(g{\Delta}Z+\frac{{\Delta}p}{\rho})}{λ\frac{l+\sum l_e}{d}+1.0+\zeta _c}}=0\\
迭代公式为\\
\lambda_{k+1}=\lambda_{k}+\frac{fg_{Re}-gf_{Re}|_{(\lambda_k,Re_k)}}{g_{\lambda}f_{Re}-f_{\lambda}g_{Re}|_{(\lambda_k,Re_k)}}\\
Re_{k+1}=Re_k+\frac{gf_{\lambda}-fg_{\lambda}|_{(\lambda_k,Re_k)}}{g_{\lambda}f_{Re}-f_{\lambda}g_{Re}|_{(\lambda_k,Re_k)}}
$$

1. 对层流时Re-λ关系式、湍流时Re-λ关系式、伯努利方程进行变形，得到迭代需要的方程形式
2. 将变形后的层流时Re-λ关系式、湍流时Re-λ关系式、伯努利方程分别对λ、Re求偏导数
3. 将变形后的层流时Re-λ关系式、湍流时Re-λ关系式分别与伯努利方程联立
4. 将得到的偏导数带入上述迭代公式中，对联系的二元非线性方程组进行迭代计算

# 需要注意的点

## scipy.optimize.root求根

```python
scipy.optimize.root(f, x0, arg=(), method=‘’,jac=None, tol=None)
'''
f:需要求解的目标函数
x0: 初始值
arg: 传递给目标函数或者雅可比行列式的额外参数 
Method: 求解器类型。hybr, lm, broyden1, broyden2, 
anderson, linearmixing, diagbroyden, excitingmixing,
krylov, df-sane.
jac: 是否使用雅可比行列式 
tol: 精度
'''
```

### 在二元方程求解时，对于给定某一变量值，求另一个变量值时

例如，给定雷诺数Re，求摩擦系数λ

```python
def turbulent_flow_equation(r, Re):  # 湍流公式
    '''
    :param Re: 雷诺数
    :param r: 摩擦系数
    :return: 湍流方程(Colebrook公式)
    '''
    return -1 / np.sqrt(r) + 2 * np.log10(d / e) + 1.14 - 2 * np.log10(1 + 9.35 * (d / e) / Re / np.sqrt(r))
Re = 1e4
root(turbulent_flow_equation, x0=1e-3, args=(Re)) # 将Re作为参数传递给目标函数
```

### 求解时，应该注意x0(初值)的选取

例如，在求解塔板温度时

1. 迭代初值选择x0=110.6

   ```python
   import numpy as np
   import math
   from scipy.optimize import root
   
   def get_t(y):
       '''
       :param y: 轻组分的摩尔分数
       :return: 根据安度因方程计算所得的塔板温度
       '''
       p = 101.325
       t1 = 80  # 苯沸点
       t2 = 110.6  # 甲苯沸点
   
       def pA0(t):  # 苯的安托因方程
           return math.pow(10, 6.031 - 1211 / (t + 220.8))
   
       def pB0(t):  # 甲苯的安托因方程
           return math.pow(10, 6.08 - 1345 / (t + 219.5))
   
       def f(t, y):
           return y * p * (pA0(t) - pB0(t)) - pA0(t) * (p - pB0(t))
   
       return round(root(f, x0=max(t1,t2), args=(y))['x'][0], 1)
   
   # 每一块塔板,气液相平衡时苯的气相摩尔分率
   Y = [0.95, 0.9026479750778815, 0.8314321616240737, 0.7387104593683607, 0.638274829077729, 0.5490129085412621,
            0.4825961296886448, 0.3474773075644578, 0.22029231462518206, 0.12159428562669743, 0.05586527608254022]
   ls = [] # 存储每一块塔板的温度
   for y in Y:
       ls.append(get_t(y))
   ls # 结果为:[82.5, 84.7, 87.7, 91.2, 94.6, 97.3, 99.2, 102.8, 105.9, 108.1, 109.5]
   ```

2. 迭代初值选择x0=80

   ```python
   ls #结果为:[82.5, 84.7, 87.7, 91.2, 94.6, 97.3, 99.2, 80.0, -212.4, -211.4, -211.3]
   ```


**可以看出，针对不同的x0初值，应用root函数求解出来的结果是不一样的，因此我们在求解时，应该避免使用产生错误的初值**

**同时，在选取初值时，也应该避免选取数值0，因为0有可能会导致分母为0**

## 在程序中输入方程时，要注意参数之间\ * (  )，避免出现错误的方程